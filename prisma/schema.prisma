generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("POSTGRES_PRISMA_URL")
  directUrl = env("POSTGRES_URL_NON_POOLING")
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  username      String    @unique
  password      String
  role          String    @default("USER") // USER, CREATOR, ADMIN
  status        String    @default("ACTIVE") // ACTIVE, SUSPENDED, BANNED
  isVerified    Boolean   @default(false)
  avatar        String?
  bio           String?
  suspendedAt   DateTime?
  suspendedReason String?
  suspendedBy   String?   // Admin user ID who suspended
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  videos        Video[]
  earnings      Earning[]
  views         View[]
  reports       Report[]
  moderatedVideos Video[] @relation("ModeratedBy")
  adminActions  AdminActionLog[]
  comments      Comment[]
  likes         Like[]
  subscriptions Subscription[] @relation("Subscriber")
  subscribers   Subscription[] @relation("SubscribedTo")
}

model Video {
  id              String      @id @default(cuid())
  title           String
  description     String?
  thumbnail       String
  bunnyVideoId    String      @unique
  bunnyLibraryId  String
  duration        Int         // in seconds
  status          String      @default("PENDING") // PENDING, APPROVED, REJECTED
  rejectionReason String?
  views           Int         @default(0)
  categoryId      String?
  userId          String
  moderatedById   String?     // Admin who moderated
  moderatedAt     DateTime?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  approvedAt      DateTime?

  // Relations
  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  category        Category?   @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  moderatedBy     User?       @relation("ModeratedBy", fields: [moderatedById], references: [id], onDelete: SetNull)
  videoViews      View[]
  earnings        Earning[]
  reports         Report[]
  comments        Comment[]
  likes           Like[]
}

model View {
  id          String   @id @default(cuid())
  videoId     String
  userId      String?  // null if anonymous
  ipAddress   String
  userAgent   String?
  createdAt   DateTime @default(now())

  // Relations
  video       Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)
  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
}

model Earning {
  id              String   @id @default(cuid())
  userId          String
  videoId         String?
  amount          Float    // in USD
  views           Int      @default(0) // views counted for this earning
  status          String   @default("PENDING") // PENDING, CONFIRMED
  calculatedAt    DateTime @default(now())

  // Relations
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  video           Video?   @relation(fields: [videoId], references: [id], onDelete: Cascade)
}

model Report {
  id              String       @id @default(cuid())
  videoId         String
  reporterId      String
  reason          String
  details         String?
  status          String       @default("PENDING") // PENDING, REVIEWED, RESOLVED
  reviewedBy      String?
  reviewedAt      DateTime?
  resolutionNotes String?
  action          String?      // NO_ACTION, VIDEO_REMOVED, USER_WARNED, USER_SUSPENDED, USER_BANNED
  createdAt       DateTime     @default(now())

  // Relations
  video       Video        @relation(fields: [videoId], references: [id], onDelete: Cascade)
  reporter    User         @relation(fields: [reporterId], references: [id], onDelete: Cascade)
}

model Category {
  id          String   @id @default(cuid())
  name        String   @unique
  slug        String   @unique
  description String?
  icon        String?  // emoji or icon name
  color       String?  // hex color for UI
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  videos      Video[]
}

model Settings {
  id                    String   @id @default(cuid())
  payoutRatePer1000     Float    @default(5.0)
  minimumPayoutAmount   Float    @default(50.0)
  ageVerificationText   String   @default("You must be 18 years or older to access this content.")
  platformName          String   @default("Video Platform")
  updatedAt             DateTime @updatedAt
}

model AdminActionLog {
  id          String   @id @default(cuid())
  adminId     String
  action      String   // VIDEO_APPROVED, VIDEO_REJECTED, VIDEO_DELETED, USER_SUSPENDED, USER_BANNED, etc.
  targetType  String   // VIDEO, USER, REPORT
  targetId    String
  reason      String?
  metadata    String?  // JSON string for additional data
  ipAddress   String?
  createdAt   DateTime @default(now())

  // Relations
  admin       User     @relation(fields: [adminId], references: [id], onDelete: Cascade)
}

model Comment {
  id          String   @id @default(cuid())
  content     String
  videoId     String
  userId      String
  parentId    String?  // For nested replies
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  video       Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  parent      Comment? @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies     Comment[] @relation("CommentReplies")

  @@index([videoId])
  @@index([userId])
}

model Like {
  id          String   @id @default(cuid())
  videoId     String
  userId      String
  createdAt   DateTime @default(now())

  // Relations
  video       Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([videoId, userId]) // User can only like a video once
  @@index([videoId])
  @@index([userId])
}

model Subscription {
  id            String   @id @default(cuid())
  subscriberId  String   // User who is subscribing
  subscribedToId String  // Creator being subscribed to
  createdAt     DateTime @default(now())

  // Relations
  subscriber    User     @relation("Subscriber", fields: [subscriberId], references: [id], onDelete: Cascade)
  subscribedTo  User     @relation("SubscribedTo", fields: [subscribedToId], references: [id], onDelete: Cascade)

  @@unique([subscriberId, subscribedToId]) // User can only subscribe once to a creator
  @@index([subscriberId])
  @@index([subscribedToId])
}
